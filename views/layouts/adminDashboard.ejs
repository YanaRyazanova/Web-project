<!DOCTYPE html>
<html lang="ru">
    <head>
        <%- include('../partials/head', {title: title});%>
<!--        <script>-->
<!--            function getBodyJsonAddNewColumn(form) {-->
<!--                let formData = new FormData(form);-->
<!--                return {-->
<!--                    "newColumn" : formData.get("newColumn"),-->
<!--                    "defaultValue" : formData.get("defaultValue")-->
<!--                };-->
<!--            }-->

<!--            function getBodyJsonAddNewRow(form) {-->
<!--                let formData = new FormData(form);-->
<!--                return {-->
<!--                    "newUser" : formData.get("newUser")-->
<!--                };-->
<!--            }-->

<!--            function setOnSubmit(form, getBodyJson, path) {-->
<!--                form.onsubmit = async (e) => {-->
<!--                    e.preventDefault();-->
<!--                    let response = await fetch(path, {-->
<!--                        method: 'post',-->
<!--                        headers: {-->
<!--                            'Content-Type': 'application/json',-->
<!--                        },-->
<!--                        body: JSON.stringify(getBodyJson(form))-->
<!--                    });-->
<!--                    if (response.status === 200) {-->
<!--                        alert("Успешно!")-->
<!--                        window.location.href = '/table';-->
<!--                    }-->
<!--                    else {-->
<!--                        let result = await response.json();-->
<!--                        alert(result.message);-->
<!--                        window.location.href = '/table';-->
<!--                    }-->
<!--                }-->
<!--            }-->
<!--        </script>-->
    </head>
    <body>
        <%- include('../partials/navbar', {isAuth: isAuth, name: name}); %>
        <%- include('../partials/table/table.ejs', {json: json}); %>
        <div class="wrapper">
            <div id="formContent">
                <h2>Добавить новую колонку</h2>
                <form action="/admin/api/addColumn", method="post">
                    <label>
                        <h3>Название колонки</h3>
                        <br>
                        <input class="formInput" type="text" required name="newColumn">
                    </label>
                    <br>
                    <label>
                        <h3>Значение по-умолчанию</h3>
                        <br>
                        <input class="formInput" type="text" name="defaultValue" required>
                    </label>
                    <br>
                    <input type="submit" value="Добавить">
                </form>
            </div>
        </div>
        <div class="wrapper">
            <div id="formContent">
                <h2>Добавить новую строчку</h2>
                <form action="/admin/api/addRow" method="post">
                    <label>
                        <h3>Имя</h3>
                        <br>
                        <input class="formInput" type="text" required name="newUser">
                    </label>
                    <br>
                    <input type="submit" value="Добавить">
                </form>
            </div>
        </div>
<!--        <script>-->
<!--            setOnSubmit(document.forms[0], getBodyJsonAddNewColumn, "/admin/api/addColumn")-->
<!--            setOnSubmit(document.forms[1], getBodyJsonAddNewRow,'/admin/api/addRow')-->
<!--        </script>-->
        <%- include('../partials/comments', {json: json}); %>
        <script>
            let items = JSON.parse('<%- JSON.stringify(json) %>');
            let keys = [];
            for (let key of document.querySelectorAll('th')) {
                if (key.attributes[0].value === "col") {
                    keys.push(key.innerText);
                }
            }
            document.addEventListener("DOMContentLoaded", () => {
                let selectors = document.querySelectorAll('.selector');
                for (let selector of selectors) {
                    let cellIndex = selector.parentNode.parentNode.cellIndex - 1;
                    let rowIndex = selector.parentNode.parentNode.parentNode.rowIndex - 1;
                    selector.addEventListener('change', function (e) {
                        let logJson = {
                            'value': selector.options[selector.selectedIndex].text,
                            'id': items[rowIndex]['_id'],
                            'field': keys[cellIndex]
                        };
                        let data = new FormData();
                        data.append( "json", JSON.stringify( logJson ) );
                        fetch('/editor/api/update', {
                            method: 'post',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify( logJson )
                        })
                            .then(res => res.json())
                            .then(res => console.log(res));
                    })
                }
            })
        </script>
        <footer>
            <p>© Проект выполнен в экстремальных условиях. Все права защищены.</p>
        </footer>
    </body>
</html>